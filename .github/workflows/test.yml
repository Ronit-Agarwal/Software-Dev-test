name: Test Suite

on:
  push:
    branches: [ main, develop, feat/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: |
          dart run build_runner build --delete-conflicting-outputs
          flutter gen-l10n

      - name: Run unit tests
        run: flutter test --coverage --reporter github

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
          flags: unit
          name: unit-test-coverage
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        run: |
          flutter pub global activate coverage_badge_generator
          coverage_badge_generator --input coverage/lcov.info --output coverage/coverage.svg

      - name: Upload coverage badge
        uses: actions/upload-artifact@v3
        with:
          name: coverage-badge
          path: coverage/coverage.svg

  widget-tests:
    name: Widget Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: |
          dart run build_runner build --delete-conflicting-outputs
          flutter gen-l10n

      - name: Run widget tests
        run: flutter test test/widgets/ --coverage --reporter github

      - name: Upload widget test coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
          flags: widgets
          name: widget-test-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: |
          dart run build_runner build --delete-conflicting-outputs
          flutter gen-l10n

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Run integration tests
        run: flutter test integration_test/ --reporter github

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: test_results/

  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: |
          dart run build_runner build --delete-conflicting-outputs
          flutter gen-l10n

      - name: Run accessibility tests
        run: flutter test test/accessibility/ --reporter github

      - name: Generate accessibility report
        run: |
          dart run test_cov_console --lcov=coverage/lcov.info
        continue-on-error: true

      - name: Upload accessibility report
        uses: actions/upload-artifact@v3
        with:
          name: accessibility-report
          path: coverage/

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Run linter
        run: flutter analyze

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        platform: [android, web]
        mode: [debug, release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: |
          dart run build_runner build --delete-conflicting-outputs
          flutter gen-l10n

      - name: Build Android (${{ matrix.mode }})
        if: matrix.platform == 'android'
        run: flutter build apk --${{ matrix.mode }}

      - name: Build Web (${{ matrix.mode }})
        if: matrix.platform == 'web'
        run: flutter build web --${{ matrix.mode }}

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, widget-tests, integration-tests, accessibility-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "### Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Widget Tests | ${{ needs.widget-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility Tests | ${{ needs.accessibility-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any test failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.widget-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.accessibility-tests.result == 'failure'
        run: exit 1
